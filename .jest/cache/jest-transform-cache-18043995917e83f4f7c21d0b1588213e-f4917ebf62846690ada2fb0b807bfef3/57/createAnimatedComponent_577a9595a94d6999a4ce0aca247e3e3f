3023e777ea3e2b7ef8ec183076c9b1b8
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _require = require('./AnimatedEvent'),
    AnimatedEvent = _require.AnimatedEvent;

var AnimatedProps = require('./nodes/AnimatedProps');

var React = require('React');

var ViewStylePropTypes = require('ViewStylePropTypes');

var invariant = require('fbjs/lib/invariant');

function createAnimatedComponent(Component) {
  invariant(typeof Component !== 'function' || Component.prototype && Component.prototype.isReactComponent, '`createAnimatedComponent` does not support stateless functional components; ' + 'use a class component instead.');

  var AnimatedComponent = function (_React$Component) {
    (0, _inherits2.default)(AnimatedComponent, _React$Component);

    function AnimatedComponent(props) {
      var _this;

      (0, _classCallCheck2.default)(this, AnimatedComponent);
      _this = (0, _possibleConstructorReturn2.default)(this, (0, _getPrototypeOf2.default)(AnimatedComponent).call(this, props));
      (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_component", void 0);
      (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_invokeAnimatedPropsCallbackOnMount", false);
      (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_prevComponent", void 0);
      (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_propsAnimated", void 0);
      (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_eventDetachers", []);
      (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_setComponentRef", void 0);
      (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_animatedPropsCallback", function () {
        if (_this._component == null) {
          _this._invokeAnimatedPropsCallbackOnMount = true;
        } else if (AnimatedComponent.__skipSetNativeProps_FOR_TESTS_ONLY || typeof _this._component.setNativeProps !== 'function') {
          _this.forceUpdate();
        } else if (!_this._propsAnimated.__isNative) {
          _this._component.setNativeProps(_this._propsAnimated.__getAnimatedValue());
        } else {
          throw new Error('Attempting to run JS driven animation on animated ' + 'node that has been moved to "native" earlier by starting an ' + 'animation with `useNativeDriver: true`');
        }
      });
      _this._setComponentRef = _this._setComponentRef.bind((0, _assertThisInitialized2.default)(_this));
      return _this;
    }

    (0, _createClass2.default)(AnimatedComponent, [{
      key: "componentWillUnmount",
      value: function componentWillUnmount() {
        this._propsAnimated && this._propsAnimated.__detach();

        this._detachNativeEvents();
      }
    }, {
      key: "setNativeProps",
      value: function setNativeProps(props) {
        this._component.setNativeProps(props);
      }
    }, {
      key: "UNSAFE_componentWillMount",
      value: function UNSAFE_componentWillMount() {
        this._attachProps(this.props);
      }
    }, {
      key: "componentDidMount",
      value: function componentDidMount() {
        if (this._invokeAnimatedPropsCallbackOnMount) {
          this._invokeAnimatedPropsCallbackOnMount = false;

          this._animatedPropsCallback();
        }

        this._propsAnimated.setNativeView(this._component);

        this._attachNativeEvents();
      }
    }, {
      key: "_attachNativeEvents",
      value: function _attachNativeEvents() {
        var _this2 = this;

        var scrollableNode = this._component.getScrollableNode ? this._component.getScrollableNode() : this._component;

        var _loop = function _loop(key) {
          var prop = _this2.props[key];

          if (prop instanceof AnimatedEvent && prop.__isNative) {
            prop.__attach(scrollableNode, key);

            _this2._eventDetachers.push(function () {
              return prop.__detach(scrollableNode, key);
            });
          }
        };

        for (var key in this.props) {
          _loop(key);
        }
      }
    }, {
      key: "_detachNativeEvents",
      value: function _detachNativeEvents() {
        this._eventDetachers.forEach(function (remove) {
          return remove();
        });

        this._eventDetachers = [];
      }
    }, {
      key: "_attachProps",
      value: function _attachProps(nextProps) {
        var oldPropsAnimated = this._propsAnimated;
        this._propsAnimated = new AnimatedProps(nextProps, this._animatedPropsCallback);
        oldPropsAnimated && oldPropsAnimated.__detach();
      }
    }, {
      key: "UNSAFE_componentWillReceiveProps",
      value: function UNSAFE_componentWillReceiveProps(newProps) {
        this._attachProps(newProps);
      }
    }, {
      key: "componentDidUpdate",
      value: function componentDidUpdate(prevProps) {
        if (this._component !== this._prevComponent) {
          this._propsAnimated.setNativeView(this._component);
        }

        if (this._component !== this._prevComponent || prevProps !== this.props) {
          this._detachNativeEvents();

          this._attachNativeEvents();
        }
      }
    }, {
      key: "render",
      value: function render() {
        var props = this._propsAnimated.__getValue();

        return React.createElement(Component, (0, _extends2.default)({}, props, {
          ref: this._setComponentRef,
          collapsable: this._propsAnimated.__isNative ? false : props.collapsable
        }));
      }
    }, {
      key: "_setComponentRef",
      value: function _setComponentRef(c) {
        this._prevComponent = this._component;
        this._component = c;
      }
    }, {
      key: "getNode",
      value: function getNode() {
        return this._component;
      }
    }]);
    return AnimatedComponent;
  }(React.Component);

  (0, _defineProperty2.default)(AnimatedComponent, "__skipSetNativeProps_FOR_TESTS_ONLY", false);
  var propTypes = Component.propTypes;
  AnimatedComponent.propTypes = {
    style: function style(props, propName, componentName) {
      if (!propTypes) {
        return;
      }

      for (var key in ViewStylePropTypes) {
        if (!propTypes[key] && props[key] !== undefined) {
          console.warn('You are setting the style `{ ' + key + ': ... }` as a prop. You ' + 'should nest it in a style object. ' + 'E.g. `{ style: { ' + key + ': ... } }`');
        }
      }
    }
  };
  return AnimatedComponent;
}

module.exports = createAnimatedComponent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50LmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJBbmltYXRlZEV2ZW50IiwiQW5pbWF0ZWRQcm9wcyIsIlJlYWN0IiwiVmlld1N0eWxlUHJvcFR5cGVzIiwiaW52YXJpYW50IiwiY3JlYXRlQW5pbWF0ZWRDb21wb25lbnQiLCJDb21wb25lbnQiLCJwcm90b3R5cGUiLCJpc1JlYWN0Q29tcG9uZW50IiwiQW5pbWF0ZWRDb21wb25lbnQiLCJwcm9wcyIsIl9jb21wb25lbnQiLCJfaW52b2tlQW5pbWF0ZWRQcm9wc0NhbGxiYWNrT25Nb3VudCIsIl9fc2tpcFNldE5hdGl2ZVByb3BzX0ZPUl9URVNUU19PTkxZIiwic2V0TmF0aXZlUHJvcHMiLCJmb3JjZVVwZGF0ZSIsIl9wcm9wc0FuaW1hdGVkIiwiX19pc05hdGl2ZSIsIl9fZ2V0QW5pbWF0ZWRWYWx1ZSIsIkVycm9yIiwiX3NldENvbXBvbmVudFJlZiIsImJpbmQiLCJfX2RldGFjaCIsIl9kZXRhY2hOYXRpdmVFdmVudHMiLCJfYXR0YWNoUHJvcHMiLCJfYW5pbWF0ZWRQcm9wc0NhbGxiYWNrIiwic2V0TmF0aXZlVmlldyIsIl9hdHRhY2hOYXRpdmVFdmVudHMiLCJzY3JvbGxhYmxlTm9kZSIsImdldFNjcm9sbGFibGVOb2RlIiwia2V5IiwicHJvcCIsIl9fYXR0YWNoIiwiX2V2ZW50RGV0YWNoZXJzIiwicHVzaCIsImZvckVhY2giLCJyZW1vdmUiLCJuZXh0UHJvcHMiLCJvbGRQcm9wc0FuaW1hdGVkIiwibmV3UHJvcHMiLCJwcmV2UHJvcHMiLCJfcHJldkNvbXBvbmVudCIsIl9fZ2V0VmFsdWUiLCJjb2xsYXBzYWJsZSIsImMiLCJwcm9wVHlwZXMiLCJzdHlsZSIsInByb3BOYW1lIiwiY29tcG9uZW50TmFtZSIsInVuZGVmaW5lZCIsImNvbnNvbGUiLCJ3YXJuIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBU0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2VBRXdCQSxPQUFPLENBQUMsaUJBQUQsQztJQUF4QkMsYSxZQUFBQSxhOztBQUNQLElBQU1DLGFBQWEsR0FBR0YsT0FBTyxDQUFDLHVCQUFELENBQTdCOztBQUNBLElBQU1HLEtBQUssR0FBR0gsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsSUFBTUksa0JBQWtCLEdBQUdKLE9BQU8sQ0FBQyxvQkFBRCxDQUFsQzs7QUFFQSxJQUFNSyxTQUFTLEdBQUdMLE9BQU8sQ0FBQyxvQkFBRCxDQUF6Qjs7QUFFQSxTQUFTTSx1QkFBVCxDQUFpQ0MsU0FBakMsRUFBc0Q7QUFDcERGLEVBQUFBLFNBQVMsQ0FDUCxPQUFPRSxTQUFQLEtBQXFCLFVBQXJCLElBQ0dBLFNBQVMsQ0FBQ0MsU0FBVixJQUF1QkQsU0FBUyxDQUFDQyxTQUFWLENBQW9CQyxnQkFGdkMsRUFHUCxpRkFDRSxnQ0FKSyxDQUFUOztBQURvRCxNQVE5Q0MsaUJBUjhDO0FBQUE7O0FBa0JsRCwrQkFBWUMsS0FBWixFQUEyQjtBQUFBOztBQUFBO0FBQ3pCLHlIQUFNQSxLQUFOO0FBRHlCO0FBQUEsd0hBUm9CLEtBUXBCO0FBQUE7QUFBQTtBQUFBLG9HQUxRLEVBS1I7QUFBQTtBQUFBLDJHQXNERixZQUFNO0FBQzdCLFlBQUksTUFBS0MsVUFBTCxJQUFtQixJQUF2QixFQUE2QjtBQU0zQixnQkFBS0MsbUNBQUwsR0FBMkMsSUFBM0M7QUFDRCxTQVBELE1BT08sSUFDTEgsaUJBQWlCLENBQUNJLG1DQUFsQixJQUNBLE9BQU8sTUFBS0YsVUFBTCxDQUFnQkcsY0FBdkIsS0FBMEMsVUFGckMsRUFHTDtBQUNBLGdCQUFLQyxXQUFMO0FBQ0QsU0FMTSxNQUtBLElBQUksQ0FBQyxNQUFLQyxjQUFMLENBQW9CQyxVQUF6QixFQUFxQztBQUMxQyxnQkFBS04sVUFBTCxDQUFnQkcsY0FBaEIsQ0FDRSxNQUFLRSxjQUFMLENBQW9CRSxrQkFBcEIsRUFERjtBQUdELFNBSk0sTUFJQTtBQUNMLGdCQUFNLElBQUlDLEtBQUosQ0FDSix1REFDRSw4REFERixHQUVFLHdDQUhFLENBQU47QUFLRDtBQUNGLE9BOUUwQjtBQUV6QixZQUFLQyxnQkFBTCxHQUF3QixNQUFLQSxnQkFBTCxDQUFzQkMsSUFBdEIsNkNBQXhCO0FBRnlCO0FBRzFCOztBQXJCaUQ7QUFBQTtBQUFBLDZDQXVCM0I7QUFDckIsYUFBS0wsY0FBTCxJQUF1QixLQUFLQSxjQUFMLENBQW9CTSxRQUFwQixFQUF2Qjs7QUFDQSxhQUFLQyxtQkFBTDtBQUNEO0FBMUJpRDtBQUFBO0FBQUEscUNBNEJuQ2IsS0E1Qm1DLEVBNEI1QjtBQUNwQixhQUFLQyxVQUFMLENBQWdCRyxjQUFoQixDQUErQkosS0FBL0I7QUFDRDtBQTlCaUQ7QUFBQTtBQUFBLGtEQWdDdEI7QUFDMUIsYUFBS2MsWUFBTCxDQUFrQixLQUFLZCxLQUF2QjtBQUNEO0FBbENpRDtBQUFBO0FBQUEsMENBb0M5QjtBQUNsQixZQUFJLEtBQUtFLG1DQUFULEVBQThDO0FBQzVDLGVBQUtBLG1DQUFMLEdBQTJDLEtBQTNDOztBQUNBLGVBQUthLHNCQUFMO0FBQ0Q7O0FBRUQsYUFBS1QsY0FBTCxDQUFvQlUsYUFBcEIsQ0FBa0MsS0FBS2YsVUFBdkM7O0FBQ0EsYUFBS2dCLG1CQUFMO0FBQ0Q7QUE1Q2lEO0FBQUE7QUFBQSw0Q0E4QzVCO0FBQUE7O0FBR3BCLFlBQU1DLGNBQWMsR0FBRyxLQUFLakIsVUFBTCxDQUFnQmtCLGlCQUFoQixHQUNuQixLQUFLbEIsVUFBTCxDQUFnQmtCLGlCQUFoQixFQURtQixHQUVuQixLQUFLbEIsVUFGVDs7QUFIb0IsbUNBT1RtQixHQVBTO0FBUWxCLGNBQU1DLElBQUksR0FBRyxNQUFJLENBQUNyQixLQUFMLENBQVdvQixHQUFYLENBQWI7O0FBQ0EsY0FBSUMsSUFBSSxZQUFZL0IsYUFBaEIsSUFBaUMrQixJQUFJLENBQUNkLFVBQTFDLEVBQXNEO0FBQ3BEYyxZQUFBQSxJQUFJLENBQUNDLFFBQUwsQ0FBY0osY0FBZCxFQUE4QkUsR0FBOUI7O0FBQ0EsWUFBQSxNQUFJLENBQUNHLGVBQUwsQ0FBcUJDLElBQXJCLENBQTBCO0FBQUEscUJBQU1ILElBQUksQ0FBQ1QsUUFBTCxDQUFjTSxjQUFkLEVBQThCRSxHQUE5QixDQUFOO0FBQUEsYUFBMUI7QUFDRDtBQVppQjs7QUFPcEIsYUFBSyxJQUFNQSxHQUFYLElBQWtCLEtBQUtwQixLQUF2QixFQUE4QjtBQUFBLGdCQUFuQm9CLEdBQW1CO0FBTTdCO0FBQ0Y7QUE1RGlEO0FBQUE7QUFBQSw0Q0E4RDVCO0FBQ3BCLGFBQUtHLGVBQUwsQ0FBcUJFLE9BQXJCLENBQTZCLFVBQUFDLE1BQU07QUFBQSxpQkFBSUEsTUFBTSxFQUFWO0FBQUEsU0FBbkM7O0FBQ0EsYUFBS0gsZUFBTCxHQUF1QixFQUF2QjtBQUNEO0FBakVpRDtBQUFBO0FBQUEsbUNBa0dyQ0ksU0FsR3FDLEVBa0cxQjtBQUN0QixZQUFNQyxnQkFBZ0IsR0FBRyxLQUFLdEIsY0FBOUI7QUFFQSxhQUFLQSxjQUFMLEdBQXNCLElBQUlmLGFBQUosQ0FDcEJvQyxTQURvQixFQUVwQixLQUFLWixzQkFGZSxDQUF0QjtBQWFBYSxRQUFBQSxnQkFBZ0IsSUFBSUEsZ0JBQWdCLENBQUNoQixRQUFqQixFQUFwQjtBQUNEO0FBbkhpRDtBQUFBO0FBQUEsdURBcUhqQmlCLFFBckhpQixFQXFIUDtBQUN6QyxhQUFLZixZQUFMLENBQWtCZSxRQUFsQjtBQUNEO0FBdkhpRDtBQUFBO0FBQUEseUNBeUgvQkMsU0F6SCtCLEVBeUhwQjtBQUM1QixZQUFJLEtBQUs3QixVQUFMLEtBQW9CLEtBQUs4QixjQUE3QixFQUE2QztBQUMzQyxlQUFLekIsY0FBTCxDQUFvQlUsYUFBcEIsQ0FBa0MsS0FBS2YsVUFBdkM7QUFDRDs7QUFDRCxZQUFJLEtBQUtBLFVBQUwsS0FBb0IsS0FBSzhCLGNBQXpCLElBQTJDRCxTQUFTLEtBQUssS0FBSzlCLEtBQWxFLEVBQXlFO0FBQ3ZFLGVBQUthLG1CQUFMOztBQUNBLGVBQUtJLG1CQUFMO0FBQ0Q7QUFDRjtBQWpJaUQ7QUFBQTtBQUFBLCtCQW1JekM7QUFDUCxZQUFNakIsS0FBSyxHQUFHLEtBQUtNLGNBQUwsQ0FBb0IwQixVQUFwQixFQUFkOztBQUNBLGVBQ0Usb0JBQUMsU0FBRCw2QkFDTWhDLEtBRE47QUFFRSxVQUFBLEdBQUcsRUFBRSxLQUFLVSxnQkFGWjtBQU9FLFVBQUEsV0FBVyxFQUNULEtBQUtKLGNBQUwsQ0FBb0JDLFVBQXBCLEdBQWlDLEtBQWpDLEdBQXlDUCxLQUFLLENBQUNpQztBQVJuRCxXQURGO0FBYUQ7QUFsSmlEO0FBQUE7QUFBQSx1Q0FvSmpDQyxDQXBKaUMsRUFvSjlCO0FBQ2xCLGFBQUtILGNBQUwsR0FBc0IsS0FBSzlCLFVBQTNCO0FBQ0EsYUFBS0EsVUFBTCxHQUFrQmlDLENBQWxCO0FBQ0Q7QUF2SmlEO0FBQUE7QUFBQSxnQ0EySnhDO0FBQ1IsZUFBTyxLQUFLakMsVUFBWjtBQUNEO0FBN0ppRDtBQUFBO0FBQUEsSUFRcEJULEtBQUssQ0FBQ0ksU0FSYzs7QUFBQSxnQ0FROUNHLGlCQVI4Qyx5Q0FnQkwsS0FoQks7QUFnS3BELE1BQU1vQyxTQUFTLEdBQUd2QyxTQUFTLENBQUN1QyxTQUE1QjtBQUVBcEMsRUFBQUEsaUJBQWlCLENBQUNvQyxTQUFsQixHQUE4QjtBQUM1QkMsSUFBQUEsS0FBSyxFQUFFLGVBQVNwQyxLQUFULEVBQWdCcUMsUUFBaEIsRUFBMEJDLGFBQTFCLEVBQXlDO0FBQzlDLFVBQUksQ0FBQ0gsU0FBTCxFQUFnQjtBQUNkO0FBQ0Q7O0FBRUQsV0FBSyxJQUFNZixHQUFYLElBQWtCM0Isa0JBQWxCLEVBQXNDO0FBQ3BDLFlBQUksQ0FBQzBDLFNBQVMsQ0FBQ2YsR0FBRCxDQUFWLElBQW1CcEIsS0FBSyxDQUFDb0IsR0FBRCxDQUFMLEtBQWVtQixTQUF0QyxFQUFpRDtBQUMvQ0MsVUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQ0Usa0NBQ0VyQixHQURGLEdBRUUsMEJBRkYsR0FHRSxvQ0FIRixHQUlFLG1CQUpGLEdBS0VBLEdBTEYsR0FNRSxZQVBKO0FBU0Q7QUFDRjtBQUNGO0FBbkIyQixHQUE5QjtBQXNCQSxTQUFPckIsaUJBQVA7QUFDRDs7QUFFRDJDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmhELHVCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqIEBmb3JtYXRcbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCB7QW5pbWF0ZWRFdmVudH0gPSByZXF1aXJlKCcuL0FuaW1hdGVkRXZlbnQnKTtcbmNvbnN0IEFuaW1hdGVkUHJvcHMgPSByZXF1aXJlKCcuL25vZGVzL0FuaW1hdGVkUHJvcHMnKTtcbmNvbnN0IFJlYWN0ID0gcmVxdWlyZSgnUmVhY3QnKTtcbmNvbnN0IFZpZXdTdHlsZVByb3BUeXBlcyA9IHJlcXVpcmUoJ1ZpZXdTdHlsZVByb3BUeXBlcycpO1xuXG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdmYmpzL2xpYi9pbnZhcmlhbnQnKTtcblxuZnVuY3Rpb24gY3JlYXRlQW5pbWF0ZWRDb21wb25lbnQoQ29tcG9uZW50OiBhbnkpOiBhbnkge1xuICBpbnZhcmlhbnQoXG4gICAgdHlwZW9mIENvbXBvbmVudCAhPT0gJ2Z1bmN0aW9uJyB8fFxuICAgICAgKENvbXBvbmVudC5wcm90b3R5cGUgJiYgQ29tcG9uZW50LnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KSxcbiAgICAnYGNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50YCBkb2VzIG5vdCBzdXBwb3J0IHN0YXRlbGVzcyBmdW5jdGlvbmFsIGNvbXBvbmVudHM7ICcgK1xuICAgICAgJ3VzZSBhIGNsYXNzIGNvbXBvbmVudCBpbnN0ZWFkLicsXG4gICk7XG5cbiAgY2xhc3MgQW5pbWF0ZWRDb21wb25lbnQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8T2JqZWN0PiB7XG4gICAgX2NvbXBvbmVudDogYW55O1xuICAgIF9pbnZva2VBbmltYXRlZFByb3BzQ2FsbGJhY2tPbk1vdW50OiBib29sZWFuID0gZmFsc2U7XG4gICAgX3ByZXZDb21wb25lbnQ6IGFueTtcbiAgICBfcHJvcHNBbmltYXRlZDogQW5pbWF0ZWRQcm9wcztcbiAgICBfZXZlbnREZXRhY2hlcnM6IEFycmF5PEZ1bmN0aW9uPiA9IFtdO1xuICAgIF9zZXRDb21wb25lbnRSZWY6IEZ1bmN0aW9uO1xuXG4gICAgc3RhdGljIF9fc2tpcFNldE5hdGl2ZVByb3BzX0ZPUl9URVNUU19PTkxZID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm9wczogT2JqZWN0KSB7XG4gICAgICBzdXBlcihwcm9wcyk7XG4gICAgICB0aGlzLl9zZXRDb21wb25lbnRSZWYgPSB0aGlzLl9zZXRDb21wb25lbnRSZWYuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICAgIHRoaXMuX3Byb3BzQW5pbWF0ZWQgJiYgdGhpcy5fcHJvcHNBbmltYXRlZC5fX2RldGFjaCgpO1xuICAgICAgdGhpcy5fZGV0YWNoTmF0aXZlRXZlbnRzKCk7XG4gICAgfVxuXG4gICAgc2V0TmF0aXZlUHJvcHMocHJvcHMpIHtcbiAgICAgIHRoaXMuX2NvbXBvbmVudC5zZXROYXRpdmVQcm9wcyhwcm9wcyk7XG4gICAgfVxuXG4gICAgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCgpIHtcbiAgICAgIHRoaXMuX2F0dGFjaFByb3BzKHRoaXMucHJvcHMpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgaWYgKHRoaXMuX2ludm9rZUFuaW1hdGVkUHJvcHNDYWxsYmFja09uTW91bnQpIHtcbiAgICAgICAgdGhpcy5faW52b2tlQW5pbWF0ZWRQcm9wc0NhbGxiYWNrT25Nb3VudCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9hbmltYXRlZFByb3BzQ2FsbGJhY2soKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZC5zZXROYXRpdmVWaWV3KHRoaXMuX2NvbXBvbmVudCk7XG4gICAgICB0aGlzLl9hdHRhY2hOYXRpdmVFdmVudHMoKTtcbiAgICB9XG5cbiAgICBfYXR0YWNoTmF0aXZlRXZlbnRzKCkge1xuICAgICAgLy8gTWFrZSBzdXJlIHRvIGdldCB0aGUgc2Nyb2xsYWJsZSBub2RlIGZvciBjb21wb25lbnRzIHRoYXQgaW1wbGVtZW50XG4gICAgICAvLyBgU2Nyb2xsUmVzcG9uZGVyLk1peGluYC5cbiAgICAgIGNvbnN0IHNjcm9sbGFibGVOb2RlID0gdGhpcy5fY29tcG9uZW50LmdldFNjcm9sbGFibGVOb2RlXG4gICAgICAgID8gdGhpcy5fY29tcG9uZW50LmdldFNjcm9sbGFibGVOb2RlKClcbiAgICAgICAgOiB0aGlzLl9jb21wb25lbnQ7XG5cbiAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMucHJvcHMpIHtcbiAgICAgICAgY29uc3QgcHJvcCA9IHRoaXMucHJvcHNba2V5XTtcbiAgICAgICAgaWYgKHByb3AgaW5zdGFuY2VvZiBBbmltYXRlZEV2ZW50ICYmIHByb3AuX19pc05hdGl2ZSkge1xuICAgICAgICAgIHByb3AuX19hdHRhY2goc2Nyb2xsYWJsZU5vZGUsIGtleSk7XG4gICAgICAgICAgdGhpcy5fZXZlbnREZXRhY2hlcnMucHVzaCgoKSA9PiBwcm9wLl9fZGV0YWNoKHNjcm9sbGFibGVOb2RlLCBrZXkpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIF9kZXRhY2hOYXRpdmVFdmVudHMoKSB7XG4gICAgICB0aGlzLl9ldmVudERldGFjaGVycy5mb3JFYWNoKHJlbW92ZSA9PiByZW1vdmUoKSk7XG4gICAgICB0aGlzLl9ldmVudERldGFjaGVycyA9IFtdO1xuICAgIH1cblxuICAgIC8vIFRoZSBzeXN0ZW0gaXMgYmVzdCBkZXNpZ25lZCB3aGVuIHNldE5hdGl2ZVByb3BzIGlzIGltcGxlbWVudGVkLiBJdCBpc1xuICAgIC8vIGFibGUgdG8gYXZvaWQgcmUtcmVuZGVyaW5nIGFuZCBkaXJlY3RseSBzZXQgdGhlIGF0dHJpYnV0ZXMgdGhhdCBjaGFuZ2VkLlxuICAgIC8vIEhvd2V2ZXIsIHNldE5hdGl2ZVByb3BzIGNhbiBvbmx5IGJlIGltcGxlbWVudGVkIG9uIGxlYWYgbmF0aXZlXG4gICAgLy8gY29tcG9uZW50cy4gSWYgeW91IHdhbnQgdG8gYW5pbWF0ZSBhIGNvbXBvc2l0ZSBjb21wb25lbnQsIHlvdSBuZWVkIHRvXG4gICAgLy8gcmUtcmVuZGVyIGl0LiBJbiB0aGlzIGNhc2UsIHdlIGhhdmUgYSBmYWxsYmFjayB0aGF0IHVzZXMgZm9yY2VVcGRhdGUuXG4gICAgX2FuaW1hdGVkUHJvcHNDYWxsYmFjayA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLl9jb21wb25lbnQgPT0gbnVsbCkge1xuICAgICAgICAvLyBBbmltYXRlZFByb3BzIGlzIGNyZWF0ZWQgaW4gd2lsbC1tb3VudCBiZWNhdXNlIGl0J3MgdXNlZCBpbiByZW5kZXIuXG4gICAgICAgIC8vIEJ1dCB0aGlzIGNhbGxiYWNrIG1heSBiZSBpbnZva2VkIGJlZm9yZSBtb3VudCBpbiBhc3luYyBtb2RlLFxuICAgICAgICAvLyBJbiB3aGljaCBjYXNlIHdlIHNob3VsZCBkZWZlciB0aGUgc2V0TmF0aXZlUHJvcHMoKSBjYWxsLlxuICAgICAgICAvLyBSZWFjdCBtYXkgdGhyb3cgYXdheSB1bmNvbW1pdHRlZCB3b3JrIGluIGFzeW5jIG1vZGUsXG4gICAgICAgIC8vIFNvIGEgZGVmZXJyZWQgY2FsbCB3b24ndCBhbHdheXMgYmUgaW52b2tlZC5cbiAgICAgICAgdGhpcy5faW52b2tlQW5pbWF0ZWRQcm9wc0NhbGxiYWNrT25Nb3VudCA9IHRydWU7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICBBbmltYXRlZENvbXBvbmVudC5fX3NraXBTZXROYXRpdmVQcm9wc19GT1JfVEVTVFNfT05MWSB8fFxuICAgICAgICB0eXBlb2YgdGhpcy5fY29tcG9uZW50LnNldE5hdGl2ZVByb3BzICE9PSAnZnVuY3Rpb24nXG4gICAgICApIHtcbiAgICAgICAgdGhpcy5mb3JjZVVwZGF0ZSgpO1xuICAgICAgfSBlbHNlIGlmICghdGhpcy5fcHJvcHNBbmltYXRlZC5fX2lzTmF0aXZlKSB7XG4gICAgICAgIHRoaXMuX2NvbXBvbmVudC5zZXROYXRpdmVQcm9wcyhcbiAgICAgICAgICB0aGlzLl9wcm9wc0FuaW1hdGVkLl9fZ2V0QW5pbWF0ZWRWYWx1ZSgpLFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdBdHRlbXB0aW5nIHRvIHJ1biBKUyBkcml2ZW4gYW5pbWF0aW9uIG9uIGFuaW1hdGVkICcgK1xuICAgICAgICAgICAgJ25vZGUgdGhhdCBoYXMgYmVlbiBtb3ZlZCB0byBcIm5hdGl2ZVwiIGVhcmxpZXIgYnkgc3RhcnRpbmcgYW4gJyArXG4gICAgICAgICAgICAnYW5pbWF0aW9uIHdpdGggYHVzZU5hdGl2ZURyaXZlcjogdHJ1ZWAnLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBfYXR0YWNoUHJvcHMobmV4dFByb3BzKSB7XG4gICAgICBjb25zdCBvbGRQcm9wc0FuaW1hdGVkID0gdGhpcy5fcHJvcHNBbmltYXRlZDtcblxuICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZCA9IG5ldyBBbmltYXRlZFByb3BzKFxuICAgICAgICBuZXh0UHJvcHMsXG4gICAgICAgIHRoaXMuX2FuaW1hdGVkUHJvcHNDYWxsYmFjayxcbiAgICAgICk7XG5cbiAgICAgIC8vIFdoZW4geW91IGNhbGwgZGV0YWNoLCBpdCByZW1vdmVzIHRoZSBlbGVtZW50IGZyb20gdGhlIHBhcmVudCBsaXN0XG4gICAgICAvLyBvZiBjaGlsZHJlbi4gSWYgaXQgZ29lcyB0byAwLCB0aGVuIHRoZSBwYXJlbnQgYWxzbyBkZXRhY2hlcyBpdHNlbGZcbiAgICAgIC8vIGFuZCBzbyBvbi5cbiAgICAgIC8vIEFuIG9wdGltaXphdGlvbiBpcyB0byBhdHRhY2ggdGhlIG5ldyBlbGVtZW50cyBhbmQgVEhFTiBkZXRhY2ggdGhlIG9sZFxuICAgICAgLy8gb25lcyBpbnN0ZWFkIG9mIGRldGFjaGluZyBhbmQgVEhFTiBhdHRhY2hpbmcuXG4gICAgICAvLyBUaGlzIHdheSB0aGUgaW50ZXJtZWRpYXRlIHN0YXRlIGlzbid0IHRvIGdvIHRvIDAgYW5kIHRyaWdnZXJcbiAgICAgIC8vIHRoaXMgZXhwZW5zaXZlIHJlY3Vyc2l2ZSBkZXRhY2hpbmcgdG8gdGhlbiByZS1hdHRhY2ggZXZlcnl0aGluZyBvblxuICAgICAgLy8gdGhlIHZlcnkgbmV4dCBvcGVyYXRpb24uXG4gICAgICBvbGRQcm9wc0FuaW1hdGVkICYmIG9sZFByb3BzQW5pbWF0ZWQuX19kZXRhY2goKTtcbiAgICB9XG5cbiAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcykge1xuICAgICAgdGhpcy5fYXR0YWNoUHJvcHMobmV3UHJvcHMpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMpIHtcbiAgICAgIGlmICh0aGlzLl9jb21wb25lbnQgIT09IHRoaXMuX3ByZXZDb21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZC5zZXROYXRpdmVWaWV3KHRoaXMuX2NvbXBvbmVudCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fY29tcG9uZW50ICE9PSB0aGlzLl9wcmV2Q29tcG9uZW50IHx8IHByZXZQcm9wcyAhPT0gdGhpcy5wcm9wcykge1xuICAgICAgICB0aGlzLl9kZXRhY2hOYXRpdmVFdmVudHMoKTtcbiAgICAgICAgdGhpcy5fYXR0YWNoTmF0aXZlRXZlbnRzKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgY29uc3QgcHJvcHMgPSB0aGlzLl9wcm9wc0FuaW1hdGVkLl9fZ2V0VmFsdWUoKTtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxDb21wb25lbnRcbiAgICAgICAgICB7Li4ucHJvcHN9XG4gICAgICAgICAgcmVmPXt0aGlzLl9zZXRDb21wb25lbnRSZWZ9XG4gICAgICAgICAgLy8gVGhlIG5hdGl2ZSBkcml2ZXIgdXBkYXRlcyB2aWV3cyBkaXJlY3RseSB0aHJvdWdoIHRoZSBVSSB0aHJlYWQgc28gd2VcbiAgICAgICAgICAvLyBoYXZlIHRvIG1ha2Ugc3VyZSB0aGUgdmlldyBkb2Vzbid0IGdldCBvcHRpbWl6ZWQgYXdheSBiZWNhdXNlIGl0IGNhbm5vdFxuICAgICAgICAgIC8vIGdvIHRocm91Z2ggdGhlIE5hdGl2ZVZpZXdIaWVyYXJjaHlNYW5hZ2VyIHNpbmNlIGl0IG9wZXJhdGVzIG9uIHRoZSBzaGFkb3dcbiAgICAgICAgICAvLyB0aHJlYWQuXG4gICAgICAgICAgY29sbGFwc2FibGU9e1xuICAgICAgICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZC5fX2lzTmF0aXZlID8gZmFsc2UgOiBwcm9wcy5jb2xsYXBzYWJsZVxuICAgICAgICAgIH1cbiAgICAgICAgLz5cbiAgICAgICk7XG4gICAgfVxuXG4gICAgX3NldENvbXBvbmVudFJlZihjKSB7XG4gICAgICB0aGlzLl9wcmV2Q29tcG9uZW50ID0gdGhpcy5fY29tcG9uZW50O1xuICAgICAgdGhpcy5fY29tcG9uZW50ID0gYztcbiAgICB9XG5cbiAgICAvLyBBIHRoaXJkIHBhcnR5IGxpYnJhcnkgY2FuIHVzZSBnZXROb2RlKClcbiAgICAvLyB0byBnZXQgdGhlIG5vZGUgcmVmZXJlbmNlIG9mIHRoZSBkZWNvcmF0ZWQgY29tcG9uZW50XG4gICAgZ2V0Tm9kZSgpIHtcbiAgICAgIHJldHVybiB0aGlzLl9jb21wb25lbnQ7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgcHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlcztcblxuICBBbmltYXRlZENvbXBvbmVudC5wcm9wVHlwZXMgPSB7XG4gICAgc3R5bGU6IGZ1bmN0aW9uKHByb3BzLCBwcm9wTmFtZSwgY29tcG9uZW50TmFtZSkge1xuICAgICAgaWYgKCFwcm9wVHlwZXMpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiBWaWV3U3R5bGVQcm9wVHlwZXMpIHtcbiAgICAgICAgaWYgKCFwcm9wVHlwZXNba2V5XSAmJiBwcm9wc1trZXldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICAnWW91IGFyZSBzZXR0aW5nIHRoZSBzdHlsZSBgeyAnICtcbiAgICAgICAgICAgICAga2V5ICtcbiAgICAgICAgICAgICAgJzogLi4uIH1gIGFzIGEgcHJvcC4gWW91ICcgK1xuICAgICAgICAgICAgICAnc2hvdWxkIG5lc3QgaXQgaW4gYSBzdHlsZSBvYmplY3QuICcgK1xuICAgICAgICAgICAgICAnRS5nLiBgeyBzdHlsZTogeyAnICtcbiAgICAgICAgICAgICAga2V5ICtcbiAgICAgICAgICAgICAgJzogLi4uIH0gfWAnLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuICB9O1xuXG4gIHJldHVybiBBbmltYXRlZENvbXBvbmVudDtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBjcmVhdGVBbmltYXRlZENvbXBvbmVudDtcbiJdfQ==