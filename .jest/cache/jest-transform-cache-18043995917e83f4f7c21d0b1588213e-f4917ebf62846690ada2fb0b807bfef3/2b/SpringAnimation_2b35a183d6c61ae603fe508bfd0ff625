dfb60c6c0a7b7abb4b5a4341ba022811
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var AnimatedValue = require('../nodes/AnimatedValue');

var AnimatedValueXY = require('../nodes/AnimatedValueXY');

var Animation = require('./Animation');

var SpringConfig = require('../SpringConfig');

var invariant = require('fbjs/lib/invariant');

var _require = require('../NativeAnimatedHelper'),
    shouldUseNativeDriver = _require.shouldUseNativeDriver;

function withDefault(value, defaultValue) {
  if (value === undefined || value === null) {
    return defaultValue;
  }

  return value;
}

var SpringAnimation = function (_Animation) {
  (0, _inherits2.default)(SpringAnimation, _Animation);

  function SpringAnimation(config) {
    var _this;

    (0, _classCallCheck2.default)(this, SpringAnimation);
    _this = (0, _possibleConstructorReturn2.default)(this, (0, _getPrototypeOf2.default)(SpringAnimation).call(this));
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_overshootClamping", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_restDisplacementThreshold", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_restSpeedThreshold", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_lastVelocity", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_startPosition", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_lastPosition", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_fromValue", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_toValue", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_stiffness", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_damping", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_mass", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_initialVelocity", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_delay", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_timeout", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_startTime", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_lastTime", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_frameTime", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_onUpdate", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_animationFrame", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "_useNativeDriver", void 0);
    _this._overshootClamping = withDefault(config.overshootClamping, false);
    _this._restDisplacementThreshold = withDefault(config.restDisplacementThreshold, 0.001);
    _this._restSpeedThreshold = withDefault(config.restSpeedThreshold, 0.001);
    _this._initialVelocity = withDefault(config.velocity, 0);
    _this._lastVelocity = withDefault(config.velocity, 0);
    _this._toValue = config.toValue;
    _this._delay = withDefault(config.delay, 0);
    _this._useNativeDriver = shouldUseNativeDriver(config);
    _this.__isInteraction = config.isInteraction !== undefined ? config.isInteraction : true;
    _this.__iterations = config.iterations !== undefined ? config.iterations : 1;

    if (config.stiffness !== undefined || config.damping !== undefined || config.mass !== undefined) {
      invariant(config.bounciness === undefined && config.speed === undefined && config.tension === undefined && config.friction === undefined, 'You can define one of bounciness/speed, tension/friction, or stiffness/damping/mass, but not more than one');
      _this._stiffness = withDefault(config.stiffness, 100);
      _this._damping = withDefault(config.damping, 10);
      _this._mass = withDefault(config.mass, 1);
    } else if (config.bounciness !== undefined || config.speed !== undefined) {
      invariant(config.tension === undefined && config.friction === undefined && config.stiffness === undefined && config.damping === undefined && config.mass === undefined, 'You can define one of bounciness/speed, tension/friction, or stiffness/damping/mass, but not more than one');
      var springConfig = SpringConfig.fromBouncinessAndSpeed(withDefault(config.bounciness, 8), withDefault(config.speed, 12));
      _this._stiffness = springConfig.stiffness;
      _this._damping = springConfig.damping;
      _this._mass = 1;
    } else {
      var _springConfig = SpringConfig.fromOrigamiTensionAndFriction(withDefault(config.tension, 40), withDefault(config.friction, 7));

      _this._stiffness = _springConfig.stiffness;
      _this._damping = _springConfig.damping;
      _this._mass = 1;
    }

    invariant(_this._stiffness > 0, 'Stiffness value must be greater than 0');
    invariant(_this._damping > 0, 'Damping value must be greater than 0');
    invariant(_this._mass > 0, 'Mass value must be greater than 0');
    return _this;
  }

  (0, _createClass2.default)(SpringAnimation, [{
    key: "__getNativeAnimationConfig",
    value: function __getNativeAnimationConfig() {
      return {
        type: 'spring',
        overshootClamping: this._overshootClamping,
        restDisplacementThreshold: this._restDisplacementThreshold,
        restSpeedThreshold: this._restSpeedThreshold,
        stiffness: this._stiffness,
        damping: this._damping,
        mass: this._mass,
        initialVelocity: withDefault(this._initialVelocity, this._lastVelocity),
        toValue: this._toValue,
        iterations: this.__iterations
      };
    }
  }, {
    key: "start",
    value: function start(fromValue, onUpdate, onEnd, previousAnimation, animatedValue) {
      var _this2 = this;

      this.__active = true;
      this._startPosition = fromValue;
      this._lastPosition = this._startPosition;
      this._onUpdate = onUpdate;
      this.__onEnd = onEnd;
      this._lastTime = Date.now();
      this._frameTime = 0.0;

      if (previousAnimation instanceof SpringAnimation) {
        var internalState = previousAnimation.getInternalState();
        this._lastPosition = internalState.lastPosition;
        this._lastVelocity = internalState.lastVelocity;
        this._initialVelocity = this._lastVelocity;
        this._lastTime = internalState.lastTime;
      }

      var start = function start() {
        if (_this2._useNativeDriver) {
          _this2.__startNativeAnimation(animatedValue);
        } else {
          _this2.onUpdate();
        }
      };

      if (this._delay) {
        this._timeout = setTimeout(start, this._delay);
      } else {
        start();
      }
    }
  }, {
    key: "getInternalState",
    value: function getInternalState() {
      return {
        lastPosition: this._lastPosition,
        lastVelocity: this._lastVelocity,
        lastTime: this._lastTime
      };
    }
  }, {
    key: "onUpdate",
    value: function onUpdate() {
      var MAX_STEPS = 64;
      var now = Date.now();

      if (now > this._lastTime + MAX_STEPS) {
        now = this._lastTime + MAX_STEPS;
      }

      var deltaTime = (now - this._lastTime) / 1000;
      this._frameTime += deltaTime;
      var c = this._damping;
      var m = this._mass;
      var k = this._stiffness;
      var v0 = -this._initialVelocity;
      var zeta = c / (2 * Math.sqrt(k * m));
      var omega0 = Math.sqrt(k / m);
      var omega1 = omega0 * Math.sqrt(1.0 - zeta * zeta);
      var x0 = this._toValue - this._startPosition;
      var position = 0.0;
      var velocity = 0.0;
      var t = this._frameTime;

      if (zeta < 1) {
        var envelope = Math.exp(-zeta * omega0 * t);
        position = this._toValue - envelope * ((v0 + zeta * omega0 * x0) / omega1 * Math.sin(omega1 * t) + x0 * Math.cos(omega1 * t));
        velocity = zeta * omega0 * envelope * (Math.sin(omega1 * t) * (v0 + zeta * omega0 * x0) / omega1 + x0 * Math.cos(omega1 * t)) - envelope * (Math.cos(omega1 * t) * (v0 + zeta * omega0 * x0) - omega1 * x0 * Math.sin(omega1 * t));
      } else {
        var _envelope = Math.exp(-omega0 * t);

        position = this._toValue - _envelope * (x0 + (v0 + omega0 * x0) * t);
        velocity = _envelope * (v0 * (t * omega0 - 1) + t * x0 * (omega0 * omega0));
      }

      this._lastTime = now;
      this._lastPosition = position;
      this._lastVelocity = velocity;

      this._onUpdate(position);

      if (!this.__active) {
        return;
      }

      var isOvershooting = false;

      if (this._overshootClamping && this._stiffness !== 0) {
        if (this._startPosition < this._toValue) {
          isOvershooting = position > this._toValue;
        } else {
          isOvershooting = position < this._toValue;
        }
      }

      var isVelocity = Math.abs(velocity) <= this._restSpeedThreshold;

      var isDisplacement = true;

      if (this._stiffness !== 0) {
        isDisplacement = Math.abs(this._toValue - position) <= this._restDisplacementThreshold;
      }

      if (isOvershooting || isVelocity && isDisplacement) {
        if (this._stiffness !== 0) {
          this._lastPosition = this._toValue;
          this._lastVelocity = 0;

          this._onUpdate(this._toValue);
        }

        this.__debouncedOnEnd({
          finished: true
        });

        return;
      }

      this._animationFrame = requestAnimationFrame(this.onUpdate.bind(this));
    }
  }, {
    key: "stop",
    value: function stop() {
      (0, _get2.default)((0, _getPrototypeOf2.default)(SpringAnimation.prototype), "stop", this).call(this);
      this.__active = false;
      clearTimeout(this._timeout);
      global.cancelAnimationFrame(this._animationFrame);

      this.__debouncedOnEnd({
        finished: false
      });
    }
  }]);
  return SpringAnimation;
}(Animation);

module.exports = SpringAnimation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNwcmluZ0FuaW1hdGlvbi5qcyJdLCJuYW1lcyI6WyJBbmltYXRlZFZhbHVlIiwicmVxdWlyZSIsIkFuaW1hdGVkVmFsdWVYWSIsIkFuaW1hdGlvbiIsIlNwcmluZ0NvbmZpZyIsImludmFyaWFudCIsInNob3VsZFVzZU5hdGl2ZURyaXZlciIsIndpdGhEZWZhdWx0IiwidmFsdWUiLCJkZWZhdWx0VmFsdWUiLCJ1bmRlZmluZWQiLCJTcHJpbmdBbmltYXRpb24iLCJjb25maWciLCJfb3ZlcnNob290Q2xhbXBpbmciLCJvdmVyc2hvb3RDbGFtcGluZyIsIl9yZXN0RGlzcGxhY2VtZW50VGhyZXNob2xkIiwicmVzdERpc3BsYWNlbWVudFRocmVzaG9sZCIsIl9yZXN0U3BlZWRUaHJlc2hvbGQiLCJyZXN0U3BlZWRUaHJlc2hvbGQiLCJfaW5pdGlhbFZlbG9jaXR5IiwidmVsb2NpdHkiLCJfbGFzdFZlbG9jaXR5IiwiX3RvVmFsdWUiLCJ0b1ZhbHVlIiwiX2RlbGF5IiwiZGVsYXkiLCJfdXNlTmF0aXZlRHJpdmVyIiwiX19pc0ludGVyYWN0aW9uIiwiaXNJbnRlcmFjdGlvbiIsIl9faXRlcmF0aW9ucyIsIml0ZXJhdGlvbnMiLCJzdGlmZm5lc3MiLCJkYW1waW5nIiwibWFzcyIsImJvdW5jaW5lc3MiLCJzcGVlZCIsInRlbnNpb24iLCJmcmljdGlvbiIsIl9zdGlmZm5lc3MiLCJfZGFtcGluZyIsIl9tYXNzIiwic3ByaW5nQ29uZmlnIiwiZnJvbUJvdW5jaW5lc3NBbmRTcGVlZCIsImZyb21PcmlnYW1pVGVuc2lvbkFuZEZyaWN0aW9uIiwidHlwZSIsImluaXRpYWxWZWxvY2l0eSIsImZyb21WYWx1ZSIsIm9uVXBkYXRlIiwib25FbmQiLCJwcmV2aW91c0FuaW1hdGlvbiIsImFuaW1hdGVkVmFsdWUiLCJfX2FjdGl2ZSIsIl9zdGFydFBvc2l0aW9uIiwiX2xhc3RQb3NpdGlvbiIsIl9vblVwZGF0ZSIsIl9fb25FbmQiLCJfbGFzdFRpbWUiLCJEYXRlIiwibm93IiwiX2ZyYW1lVGltZSIsImludGVybmFsU3RhdGUiLCJnZXRJbnRlcm5hbFN0YXRlIiwibGFzdFBvc2l0aW9uIiwibGFzdFZlbG9jaXR5IiwibGFzdFRpbWUiLCJzdGFydCIsIl9fc3RhcnROYXRpdmVBbmltYXRpb24iLCJfdGltZW91dCIsInNldFRpbWVvdXQiLCJNQVhfU1RFUFMiLCJkZWx0YVRpbWUiLCJjIiwibSIsImsiLCJ2MCIsInpldGEiLCJNYXRoIiwic3FydCIsIm9tZWdhMCIsIm9tZWdhMSIsIngwIiwicG9zaXRpb24iLCJ0IiwiZW52ZWxvcGUiLCJleHAiLCJzaW4iLCJjb3MiLCJpc092ZXJzaG9vdGluZyIsImlzVmVsb2NpdHkiLCJhYnMiLCJpc0Rpc3BsYWNlbWVudCIsIl9fZGVib3VuY2VkT25FbmQiLCJmaW5pc2hlZCIsIl9hbmltYXRpb25GcmFtZSIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImJpbmQiLCJjbGVhclRpbWVvdXQiLCJnbG9iYWwiLCJjYW5jZWxBbmltYXRpb25GcmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLElBQU1BLGFBQWEsR0FBR0MsT0FBTyxDQUFDLHdCQUFELENBQTdCOztBQUNBLElBQU1DLGVBQWUsR0FBR0QsT0FBTyxDQUFDLDBCQUFELENBQS9COztBQUNBLElBQU1FLFNBQVMsR0FBR0YsT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBQ0EsSUFBTUcsWUFBWSxHQUFHSCxPQUFPLENBQUMsaUJBQUQsQ0FBNUI7O0FBRUEsSUFBTUksU0FBUyxHQUFHSixPQUFPLENBQUMsb0JBQUQsQ0FBekI7O2VBQ2dDQSxPQUFPLENBQUMseUJBQUQsQztJQUFoQ0sscUIsWUFBQUEscUI7O0FBb0NQLFNBQVNDLFdBQVQsQ0FBd0JDLEtBQXhCLEVBQW1DQyxZQUFuQyxFQUF1RDtBQUNyRCxNQUFJRCxLQUFLLEtBQUtFLFNBQVYsSUFBdUJGLEtBQUssS0FBSyxJQUFyQyxFQUEyQztBQUN6QyxXQUFPQyxZ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Q2EsR0FBTCxDQUFTLEtBQUtuRSxRQUFMLEdBQWdCMkQsUUFBekIsS0FBc0MsS0FBS2xFLDBCQUQ3QztBQUVEOztBQUVELFVBQUl3RSxjQUFjLElBQUtDLFVBQVUsSUFBSUUsY0FBckMsRUFBc0Q7QUFDcEQsWUFBSSxLQUFLcEQsVUFBTCxLQUFvQixDQUF4QixFQUEyQjtBQUV6QixlQUFLZSxhQUFMLEdBQXFCLEtBQUsvQixRQUExQjtBQUNBLGVBQUtELGFBQUwsR0FBcUIsQ0FBckI7O0FBQ0EsZUFBS2lDLFNBQUwsQ0FBZSxLQUFLaEMsUUFBcEI7QUFDRDs7QUFFRCxhQUFLcUUsZ0JBQUwsQ0FBc0I7QUFBQ0MsVUFBQUEsUUFBUSxFQUFFO0FBQVgsU0FBdEI7O0FBQ0E7QUFDRDs7QUFDRCxXQUFLQyxlQUFMLEdBQXVCQyxxQkFBcUIsQ0FBQyxLQUFLL0MsUUFBTCxDQUFjZ0QsSUFBZCxDQUFtQixJQUFuQixDQUFELENBQTVDO0FBQ0Q7OzsyQkFFWTtBQUNYO0FBQ0EsV0FBSzVDLFFBQUwsR0FBZ0IsS0FBaEI7QUFDQTZDLE1BQUFBLFlBQVksQ0FBQyxLQUFLN0IsUUFBTixDQUFaO0FBQ0E4QixNQUFBQSxNQUFNLENBQUNDLG9CQUFQLENBQTRCLEtBQUtMLGVBQWpDOztBQUNBLFdBQUtGLGdCQUFMLENBQXNCO0FBQUNDLFFBQUFBLFFBQVEsRUFBRTtBQUFYLE9BQXRCO0FBQ0Q7OztFQW5SMkJ6RixTOztBQXNSOUJnRyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ6RixlQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqIEBmb3JtYXRcbiAqL1xuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBBbmltYXRlZFZhbHVlID0gcmVxdWlyZSgnLi4vbm9kZXMvQW5pbWF0ZWRWYWx1ZScpO1xuY29uc3QgQW5pbWF0ZWRWYWx1ZVhZID0gcmVxdWlyZSgnLi4vbm9kZXMvQW5pbWF0ZWRWYWx1ZVhZJyk7XG5jb25zdCBBbmltYXRpb24gPSByZXF1aXJlKCcuL0FuaW1hdGlvbicpO1xuY29uc3QgU3ByaW5nQ29uZmlnID0gcmVxdWlyZSgnLi4vU3ByaW5nQ29uZmlnJyk7XG5cbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ZianMvbGliL2ludmFyaWFudCcpO1xuY29uc3Qge3Nob3VsZFVzZU5hdGl2ZURyaXZlcn0gPSByZXF1aXJlKCcuLi9OYXRpdmVBbmltYXRlZEhlbHBlcicpO1xuXG5pbXBvcnQgdHlwZSB7QW5pbWF0aW9uQ29uZmlnLCBFbmRDYWxsYmFja30gZnJvbSAnLi9BbmltYXRpb24nO1xuXG5leHBvcnQgdHlwZSBTcHJpbmdBbmltYXRpb25Db25maWcgPSBBbmltYXRpb25Db25maWcgJiB7XG4gIHRvVmFsdWU6IG51bWJlciB8IEFuaW1hdGVkVmFsdWUgfCB7eDogbnVtYmVyLCB5OiBudW1iZXJ9IHwgQW5pbWF0ZWRWYWx1ZVhZLFxuICBvdmVyc2hvb3RDbGFtcGluZz86IGJvb2xlYW4sXG4gIHJlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQ/OiBudW1iZXIsXG4gIHJlc3RTcGVlZFRocmVzaG9sZD86IG51bWJlcixcbiAgdmVsb2NpdHk/OiBudW1iZXIgfCB7eDogbnVtYmVyLCB5OiBudW1iZXJ9LFxuICBib3VuY2luZXNzPzogbnVtYmVyLFxuICBzcGVlZD86IG51bWJlcixcbiAgdGVuc2lvbj86IG51bWJlcixcbiAgZnJpY3Rpb24/OiBudW1iZXIsXG4gIHN0aWZmbmVzcz86IG51bWJlcixcbiAgZGFtcGluZz86IG51bWJlcixcbiAgbWFzcz86IG51bWJlcixcbiAgZGVsYXk/OiBudW1iZXIsXG59O1xuXG5leHBvcnQgdHlwZSBTcHJpbmdBbmltYXRpb25Db25maWdTaW5nbGUgPSBBbmltYXRpb25Db25maWcgJiB7XG4gIHRvVmFsdWU6IG51bWJlciB8IEFuaW1hdGVkVmFsdWUsXG4gIG92ZXJzaG9vdENsYW1waW5nPzogYm9vbGVhbixcbiAgcmVzdERpc3BsYWNlbWVudFRocmVzaG9sZD86IG51bWJlcixcbiAgcmVzdFNwZWVkVGhyZXNob2xkPzogbnVtYmVyLFxuICB2ZWxvY2l0eT86IG51bWJlcixcbiAgYm91bmNpbmVzcz86IG51bWJlcixcbiAgc3BlZWQ/OiBudW1iZXIsXG4gIHRlbnNpb24/OiBudW1iZXIsXG4gIGZyaWN0aW9uPzogbnVtYmVyLFxuICBzdGlmZm5lc3M/OiBudW1iZXIsXG4gIGRhbXBpbmc/OiBudW1iZXIsXG4gIG1hc3M/OiBudW1iZXIsXG4gIGRlbGF5PzogbnVtYmVyLFxufTtcblxuZnVuY3Rpb24gd2l0aERlZmF1bHQ8VD4odmFsdWU6ID9ULCBkZWZhdWx0VmFsdWU6IFQpOiBUIHtcbiAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIHtcbiAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xuICB9XG4gIHJldHVybiB2YWx1ZTtcbn1cblxuY2xhc3MgU3ByaW5nQW5pbWF0aW9uIGV4dGVuZHMgQW5pbWF0aW9uIHtcbiAgX292ZXJzaG9vdENsYW1waW5nOiBib29sZWFuO1xuICBfcmVzdERpc3BsYWNlbWVudFRocmVzaG9sZDogbnVtYmVyO1xuICBfcmVzdFNwZWVkVGhyZXNob2xkOiBudW1iZXI7XG4gIF9sYXN0VmVsb2NpdHk6IG51bWJlcjtcbiAgX3N0YXJ0UG9zaXRpb246IG51bWJlcjtcbiAgX2xhc3RQb3NpdGlvbjogbnVtYmVyO1xuICBfZnJvbVZhbHVlOiBudW1iZXI7XG4gIF90b1ZhbHVlOiBhbnk7XG4gIF9zdGlmZm5lc3M6IG51bWJlcjtcbiAgX2RhbXBpbmc6IG51bWJlcjtcbiAgX21hc3M6IG51bWJlcjtcbiAgX2luaXRpYWxWZWxvY2l0eTogbnVtYmVyO1xuICBfZGVsYXk6IG51bWJlcjtcbiAgX3RpbWVvdXQ6IGFueTtcbiAgX3N0YXJ0VGltZTogbnVtYmVyO1xuICBfbGFzdFRpbWU6IG51bWJlcjtcbiAgX2ZyYW1lVGltZTogbnVtYmVyO1xuICBfb25VcGRhdGU6ICh2YWx1ZTogbnVtYmVyKSA9PiB2b2lkO1xuICBfYW5pbWF0aW9uRnJhbWU6IGFueTtcbiAgX3VzZU5hdGl2ZURyaXZlcjogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFNwcmluZ0FuaW1hdGlvbkNvbmZpZ1NpbmdsZSkge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLl9vdmVyc2hvb3RDbGFtcGluZyA9IHdpdGhEZWZhdWx0KGNvbmZpZy5vdmVyc2hvb3RDbGFtcGluZywgZmFsc2UpO1xuICAgIHRoaXMuX3Jlc3REaXNwbGFjZW1lbnRUaHJlc2hvbGQgPSB3aXRoRGVmYXVsdChcbiAgICAgIGNvbmZpZy5yZXN0RGlzcGxhY2VtZW50VGhyZXNob2xkLFxuICAgICAgMC4wMDEsXG4gICAgKTtcbiAgICB0aGlzLl9yZXN0U3BlZWRUaHJlc2hvbGQgPSB3aXRoRGVmYXVsdChjb25maWcucmVzdFNwZWVkVGhyZXNob2xkLCAwLjAwMSk7XG4gICAgdGhpcy5faW5pdGlhbFZlbG9jaXR5ID0gd2l0aERlZmF1bHQoY29uZmlnLnZlbG9jaXR5LCAwKTtcbiAgICB0aGlzLl9sYXN0VmVsb2NpdHkgPSB3aXRoRGVmYXVsdChjb25maWcudmVsb2NpdHksIDApO1xuICAgIHRoaXMuX3RvVmFsdWUgPSBjb25maWcudG9WYWx1ZTtcbiAgICB0aGlzLl9kZWxheSA9IHdpdGhEZWZhdWx0KGNvbmZpZy5kZWxheSwgMCk7XG4gICAgdGhpcy5fdXNlTmF0aXZlRHJpdmVyID0gc2hvdWxkVXNlTmF0aXZlRHJpdmVyKGNvbmZpZyk7XG4gICAgdGhpcy5fX2lzSW50ZXJhY3Rpb24gPVxuICAgICAgY29uZmlnLmlzSW50ZXJhY3Rpb24gIT09IHVuZGVmaW5lZCA/IGNvbmZpZy5pc0ludGVyYWN0aW9uIDogdHJ1ZTtcbiAgICB0aGlzLl9faXRlcmF0aW9ucyA9IGNvbmZpZy5pdGVyYXRpb25zICE9PSB1bmRlZmluZWQgPyBjb25maWcuaXRlcmF0aW9ucyA6IDE7XG5cbiAgICBpZiAoXG4gICAgICBjb25maWcuc3RpZmZuZXNzICE9PSB1bmRlZmluZWQgfHxcbiAgICAgIGNvbmZpZy5kYW1waW5nICE9PSB1bmRlZmluZWQgfHxcbiAgICAgIGNvbmZpZy5tYXNzICE9PSB1bmRlZmluZWRcbiAgICApIHtcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgY29uZmlnLmJvdW5jaW5lc3MgPT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgIGNvbmZpZy5zcGVlZCA9PT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgY29uZmlnLnRlbnNpb24gPT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgIGNvbmZpZy5mcmljdGlvbiA9PT0gdW5kZWZpbmVkLFxuICAgICAgICAnWW91IGNhbiBkZWZpbmUgb25lIG9mIGJvdW5jaW5lc3Mvc3BlZWQsIHRlbnNpb24vZnJpY3Rpb24sIG9yIHN0aWZmbmVzcy9kYW1waW5nL21hc3MsIGJ1dCBub3QgbW9yZSB0aGFuIG9uZScsXG4gICAgICApO1xuICAgICAgdGhpcy5fc3RpZmZuZXNzID0gd2l0aERlZmF1bHQoY29uZmlnLnN0aWZmbmVzcywgMTAwKTtcbiAgICAgIHRoaXMuX2RhbXBpbmcgPSB3aXRoRGVmYXVsdChjb25maWcuZGFtcGluZywgMTApO1xuICAgICAgdGhpcy5fbWFzcyA9IHdpdGhEZWZhdWx0KGNvbmZpZy5tYXNzLCAxKTtcbiAgICB9IGVsc2UgaWYgKGNvbmZpZy5ib3VuY2luZXNzICE9PSB1bmRlZmluZWQgfHwgY29uZmlnLnNwZWVkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIENvbnZlcnQgdGhlIG9yaWdhbWkgYm91bmNpbmVzcy9zcGVlZCB2YWx1ZXMgdG8gc3RpZmZuZXNzL2RhbXBpbmdcbiAgICAgIC8vIFdlIGFzc3VtZSBtYXNzIGlzIDEuXG4gICAgICBpbnZhcmlhbnQoXG4gICAgICAgIGNvbmZpZy50ZW5zaW9uID09PSB1bmRlZmluZWQgJiZcbiAgICAgICAgICBjb25maWcuZnJpY3Rpb24gPT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgIGNvbmZpZy5zdGlmZm5lc3MgPT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgIGNvbmZpZy5kYW1waW5nID09PSB1bmRlZmluZWQgJiZcbiAgICAgICAgICBjb25maWcubWFzcyA9PT0gdW5kZWZpbmVkLFxuICAgICAgICAnWW91IGNhbiBkZWZpbmUgb25lIG9mIGJvdW5jaW5lc3Mvc3BlZWQsIHRlbnNpb24vZnJpY3Rpb24sIG9yIHN0aWZmbmVzcy9kYW1waW5nL21hc3MsIGJ1dCBub3QgbW9yZSB0aGFuIG9uZScsXG4gICAgICApO1xuICAgICAgY29uc3Qgc3ByaW5nQ29uZmlnID0gU3ByaW5nQ29uZmlnLmZyb21Cb3VuY2luZXNzQW5kU3BlZWQoXG4gICAgICAgIHdpdGhEZWZhdWx0KGNvbmZpZy5ib3VuY2luZXNzLCA4KSxcbiAgICAgICAgd2l0aERlZmF1bHQoY29uZmlnLnNwZWVkLCAxMiksXG4gICAgICApO1xuICAgICAgdGhpcy5fc3RpZmZuZXNzID0gc3ByaW5nQ29uZmlnLnN0aWZmbmVzcztcbiAgICAgIHRoaXMuX2RhbXBpbmcgPSBzcHJpbmdDb25maWcuZGFtcGluZztcbiAgICAgIHRoaXMuX21hc3MgPSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBDb252ZXJ0IHRoZSBvcmlnYW1pIHRlbnNpb24vZnJpY3Rpb24gdmFsdWVzIHRvIHN0aWZmbmVzcy9kYW1waW5nXG4gICAgICAvLyBXZSBhc3N1bWUgbWFzcyBpcyAxLlxuICAgICAgY29uc3Qgc3ByaW5nQ29uZmlnID0gU3ByaW5nQ29uZmlnLmZyb21PcmlnYW1pVGVuc2lvbkFuZEZyaWN0aW9uKFxuICAgICAgICB3aXRoRGVmYXVsdChjb25maWcudGVuc2lvbiwgNDApLFxuICAgICAgICB3aXRoRGVmYXVsdChjb25maWcuZnJpY3Rpb24sIDcpLFxuICAgICAgKTtcbiAgICAgIHRoaXMuX3N0aWZmbmVzcyA9IHNwcmluZ0NvbmZpZy5zdGlmZm5lc3M7XG4gICAgICB0aGlzLl9kYW1waW5nID0gc3ByaW5nQ29uZmlnLmRhbXBpbmc7XG4gICAgICB0aGlzLl9tYXNzID0gMTtcbiAgICB9XG5cbiAgICBpbnZhcmlhbnQodGhpcy5fc3RpZmZuZXNzID4gMCwgJ1N0aWZmbmVzcyB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwJyk7XG4gICAgaW52YXJpYW50KHRoaXMuX2RhbXBpbmcgPiAwLCAnRGFtcGluZyB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwJyk7XG4gICAgaW52YXJpYW50KHRoaXMuX21hc3MgPiAwLCAnTWFzcyB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwJyk7XG4gIH1cblxuICBfX2dldE5hdGl2ZUFuaW1hdGlvbkNvbmZpZygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ3NwcmluZycsXG4gICAgICBvdmVyc2hvb3RDbGFtcGluZzogdGhpcy5fb3ZlcnNob290Q2xhbXBpbmcsXG4gICAgICByZXN0RGlzcGxhY2VtZW50VGhyZXNob2xkOiB0aGlzLl9yZXN0RGlzcGxhY2VtZW50VGhyZXNob2xkLFxuICAgICAgcmVzdFNwZWVkVGhyZXNob2xkOiB0aGlzLl9yZXN0U3BlZWRUaHJlc2hvbGQsXG4gICAgICBzdGlmZm5lc3M6IHRoaXMuX3N0aWZmbmVzcyxcbiAgICAgIGRhbXBpbmc6IHRoaXMuX2RhbXBpbmcsXG4gICAgICBtYXNzOiB0aGlzLl9tYXNzLFxuICAgICAgaW5pdGlhbFZlbG9jaXR5OiB3aXRoRGVmYXVsdCh0aGlzLl9pbml0aWFsVmVsb2NpdHksIHRoaXMuX2xhc3RWZWxvY2l0eSksXG4gICAgICB0b1ZhbHVlOiB0aGlzLl90b1ZhbHVlLFxuICAgICAgaXRlcmF0aW9uczogdGhpcy5fX2l0ZXJhdGlvbnMsXG4gICAgfTtcbiAgfVxuXG4gIHN0YXJ0KFxuICAgIGZyb21WYWx1ZTogbnVtYmVyLFxuICAgIG9uVXBkYXRlOiAodmFsdWU6IG51bWJlcikgPT4gdm9pZCxcbiAgICBvbkVuZDogP0VuZENhbGxiYWNrLFxuICAgIHByZXZpb3VzQW5pbWF0aW9uOiA/QW5pbWF0aW9uLFxuICAgIGFuaW1hdGVkVmFsdWU6IEFuaW1hdGVkVmFsdWUsXG4gICk6IHZvaWQge1xuICAgIHRoaXMuX19hY3RpdmUgPSB0cnVlO1xuICAgIHRoaXMuX3N0YXJ0UG9zaXRpb24gPSBmcm9tVmFsdWU7XG4gICAgdGhpcy5fbGFzdFBvc2l0aW9uID0gdGhpcy5fc3RhcnRQb3NpdGlvbjtcblxuICAgIHRoaXMuX29uVXBkYXRlID0gb25VcGRhdGU7XG4gICAgdGhpcy5fX29uRW5kID0gb25FbmQ7XG4gICAgdGhpcy5fbGFzdFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIHRoaXMuX2ZyYW1lVGltZSA9IDAuMDtcblxuICAgIGlmIChwcmV2aW91c0FuaW1hdGlvbiBpbnN0YW5jZW9mIFNwcmluZ0FuaW1hdGlvbikge1xuICAgICAgY29uc3QgaW50ZXJuYWxTdGF0ZSA9IHByZXZpb3VzQW5pbWF0aW9uLmdldEludGVybmFsU3RhdGUoKTtcbiAgICAgIHRoaXMuX2xhc3RQb3NpdGlvbiA9IGludGVybmFsU3RhdGUubGFzdFBvc2l0aW9uO1xuICAgICAgdGhpcy5fbGFzdFZlbG9jaXR5ID0gaW50ZXJuYWxTdGF0ZS5sYXN0VmVsb2NpdHk7XG4gICAgICAvLyBTZXQgdGhlIGluaXRpYWwgdmVsb2NpdHkgdG8gdGhlIGxhc3QgdmVsb2NpdHlcbiAgICAgIHRoaXMuX2luaXRpYWxWZWxvY2l0eSA9IHRoaXMuX2xhc3RWZWxvY2l0eTtcbiAgICAgIHRoaXMuX2xhc3RUaW1lID0gaW50ZXJuYWxTdGF0ZS5sYXN0VGltZTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGFydCA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLl91c2VOYXRpdmVEcml2ZXIpIHtcbiAgICAgICAgdGhpcy5fX3N0YXJ0TmF0aXZlQW5pbWF0aW9uKGFuaW1hdGVkVmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5vblVwZGF0ZSgpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyAgSWYgdGhpcy5fZGVsYXkgaXMgbW9yZSB0aGFuIDAsIHdlIHN0YXJ0IGFmdGVyIHRoZSB0aW1lb3V0LlxuICAgIGlmICh0aGlzLl9kZWxheSkge1xuICAgICAgdGhpcy5fdGltZW91dCA9IHNldFRpbWVvdXQoc3RhcnQsIHRoaXMuX2RlbGF5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3RhcnQoKTtcbiAgICB9XG4gIH1cblxuICBnZXRJbnRlcm5hbFN0YXRlKCk6IE9iamVjdCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxhc3RQb3NpdGlvbjogdGhpcy5fbGFzdFBvc2l0aW9uLFxuICAgICAgbGFzdFZlbG9jaXR5OiB0aGlzLl9sYXN0VmVsb2NpdHksXG4gICAgICBsYXN0VGltZTogdGhpcy5fbGFzdFRpbWUsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIHNwcmluZyBtb2RlbCBpcyBiYXNlZCBvZmYgb2YgYSBkYW1wZWQgaGFybW9uaWMgb3NjaWxsYXRvclxuICAgKiAoaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSGFybW9uaWNfb3NjaWxsYXRvciNEYW1wZWRfaGFybW9uaWNfb3NjaWxsYXRvcikuXG4gICAqXG4gICAqIFdlIHVzZSB0aGUgY2xvc2VkIGZvcm0gb2YgdGhlIHNlY29uZCBvcmRlciBkaWZmZXJlbnRpYWwgZXF1YXRpb246XG4gICAqXG4gICAqIHgnJyArICgyzrbijbVfMCl4JyArIOKNtV4yeCA9IDBcbiAgICpcbiAgICogd2hlcmVcbiAgICogICAg4o21XzAgPSDiiJooayAvIG0pICh1bmRhbXBlZCBhbmd1bGFyIGZyZXF1ZW5jeSBvZiB0aGUgb3NjaWxsYXRvciksXG4gICAqICAgIM62ID0gYyAvIDLiiJptayAoZGFtcGluZyByYXRpbyksXG4gICAqICAgIGMgPSBkYW1waW5nIGNvbnN0YW50XG4gICAqICAgIGsgPSBzdGlmZm5lc3NcbiAgICogICAgbSA9IG1hc3NcbiAgICpcbiAgICogVGhlIGRlcml2YXRpb24gb2YgdGhlIGNsb3NlZCBmb3JtIGlzIGRlc2NyaWJlZCBpbiBkZXRhaWwgaGVyZTpcbiAgICogaHR0cDovL3BsYW5ldG1hdGgub3JnL3NpdGVzL2RlZmF1bHQvZmlsZXMvdGV4cGRmLzM5NzQ1LnBkZlxuICAgKlxuICAgKiBUaGlzIGFsZ29yaXRobSBoYXBwZW5zIHRvIG1hdGNoIHRoZSBhbGdvcml0aG0gdXNlZCBieSBDQVNwcmluZ0FuaW1hdGlvbixcbiAgICogYSBRdWFydHpDb3JlIChpT1MpIEFQSSB0aGF0IGNyZWF0ZXMgc3ByaW5nIGFuaW1hdGlvbnMuXG4gICAqL1xuICBvblVwZGF0ZSgpOiB2b2lkIHtcbiAgICAvLyBJZiBmb3Igc29tZSByZWFzb24gd2UgbG9zdCBhIGxvdCBvZiBmcmFtZXMgKGUuZy4gcHJvY2VzcyBsYXJnZSBwYXlsb2FkIG9yXG4gICAgLy8gc3RvcHBlZCBpbiB0aGUgZGVidWdnZXIpLCB3ZSBvbmx5IGFkdmFuY2UgYnkgNCBmcmFtZXMgd29ydGggb2ZcbiAgICAvLyBjb21wdXRhdGlvbiBhbmQgd2lsbCBjb250aW51ZSBvbiB0aGUgbmV4dCBmcmFtZS4gSXQncyBiZXR0ZXIgdG8gaGF2ZSBpdFxuICAgIC8vIHJ1bm5pbmcgYXQgZmFzdGVyIHNwZWVkIHRoYW4ganVtcGluZyB0byB0aGUgZW5kLlxuICAgIGNvbnN0IE1BWF9TVEVQUyA9IDY0O1xuICAgIGxldCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGlmIChub3cgPiB0aGlzLl9sYXN0VGltZSArIE1BWF9TVEVQUykge1xuICAgICAgbm93ID0gdGhpcy5fbGFzdFRpbWUgKyBNQVhfU1RFUFM7XG4gICAgfVxuXG4gICAgY29uc3QgZGVsdGFUaW1lID0gKG5vdyAtIHRoaXMuX2xhc3RUaW1lKSAvIDEwMDA7XG4gICAgdGhpcy5fZnJhbWVUaW1lICs9IGRlbHRhVGltZTtcblxuICAgIGNvbnN0IGM6IG51bWJlciA9IHRoaXMuX2RhbXBpbmc7XG4gICAgY29uc3QgbTogbnVtYmVyID0gdGhpcy5fbWFzcztcbiAgICBjb25zdCBrOiBudW1iZXIgPSB0aGlzLl9zdGlmZm5lc3M7XG4gICAgY29uc3QgdjA6IG51bWJlciA9IC10aGlzLl9pbml0aWFsVmVsb2NpdHk7XG5cbiAgICBjb25zdCB6ZXRhID0gYyAvICgyICogTWF0aC5zcXJ0KGsgKiBtKSk7IC8vIGRhbXBpbmcgcmF0aW9cbiAgICBjb25zdCBvbWVnYTAgPSBNYXRoLnNxcnQoayAvIG0pOyAvLyB1bmRhbXBlZCBhbmd1bGFyIGZyZXF1ZW5jeSBvZiB0aGUgb3NjaWxsYXRvciAocmFkL21zKVxuICAgIGNvbnN0IG9tZWdhMSA9IG9tZWdhMCAqIE1hdGguc3FydCgxLjAgLSB6ZXRhICogemV0YSk7IC8vIGV4cG9uZW50aWFsIGRlY2F5XG4gICAgY29uc3QgeDAgPSB0aGlzLl90b1ZhbHVlIC0gdGhpcy5fc3RhcnRQb3NpdGlvbjsgLy8gY2FsY3VsYXRlIHRoZSBvc2NpbGxhdGlvbiBmcm9tIHgwID0gMSB0byB4ID0gMFxuXG4gICAgbGV0IHBvc2l0aW9uID0gMC4wO1xuICAgIGxldCB2ZWxvY2l0eSA9IDAuMDtcbiAgICBjb25zdCB0ID0gdGhpcy5fZnJhbWVUaW1lO1xuICAgIGlmICh6ZXRhIDwgMSkge1xuICAgICAgLy8gVW5kZXIgZGFtcGVkXG4gICAgICBjb25zdCBlbnZlbG9wZSA9IE1hdGguZXhwKC16ZXRhICogb21lZ2EwICogdCk7XG4gICAgICBwb3NpdGlvbiA9XG4gICAgICAgIHRoaXMuX3RvVmFsdWUgLVxuICAgICAgICBlbnZlbG9wZSAqXG4gICAgICAgICAgKCgodjAgKyB6ZXRhICogb21lZ2EwICogeDApIC8gb21lZ2ExKSAqIE1hdGguc2luKG9tZWdhMSAqIHQpICtcbiAgICAgICAgICAgIHgwICogTWF0aC5jb3Mob21lZ2ExICogdCkpO1xuICAgICAgLy8gVGhpcyBsb29rcyBjcmF6eSAtLSBpdCdzIGFjdHVhbGx5IGp1c3QgdGhlIGRlcml2YXRpdmUgb2YgdGhlXG4gICAgICAvLyBvc2NpbGxhdGlvbiBmdW5jdGlvblxuICAgICAgdmVsb2NpdHkgPVxuICAgICAgICB6ZXRhICpcbiAgICAgICAgICBvbWVnYTAgKlxuICAgICAgICAgIGVudmVsb3BlICpcbiAgICAgICAgICAoKE1hdGguc2luKG9tZWdhMSAqIHQpICogKHYwICsgemV0YSAqIG9tZWdhMCAqIHgwKSkgLyBvbWVnYTEgK1xuICAgICAgICAgICAgeDAgKiBNYXRoLmNvcyhvbWVnYTEgKiB0KSkgLVxuICAgICAgICBlbnZlbG9wZSAqXG4gICAgICAgICAgKE1hdGguY29zKG9tZWdhMSAqIHQpICogKHYwICsgemV0YSAqIG9tZWdhMCAqIHgwKSAtXG4gICAgICAgICAgICBvbWVnYTEgKiB4MCAqIE1hdGguc2luKG9tZWdhMSAqIHQpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ3JpdGljYWxseSBkYW1wZWRcbiAgICAgIGNvbnN0IGVudmVsb3BlID0gTWF0aC5leHAoLW9tZWdhMCAqIHQpO1xuICAgICAgcG9zaXRpb24gPSB0aGlzLl90b1ZhbHVlIC0gZW52ZWxvcGUgKiAoeDAgKyAodjAgKyBvbWVnYTAgKiB4MCkgKiB0KTtcbiAgICAgIHZlbG9jaXR5ID1cbiAgICAgICAgZW52ZWxvcGUgKiAodjAgKiAodCAqIG9tZWdhMCAtIDEpICsgdCAqIHgwICogKG9tZWdhMCAqIG9tZWdhMCkpO1xuICAgIH1cblxuICAgIHRoaXMuX2xhc3RUaW1lID0gbm93O1xuICAgIHRoaXMuX2xhc3RQb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgIHRoaXMuX2xhc3RWZWxvY2l0eSA9IHZlbG9jaXR5O1xuXG4gICAgdGhpcy5fb25VcGRhdGUocG9zaXRpb24pO1xuICAgIGlmICghdGhpcy5fX2FjdGl2ZSkge1xuICAgICAgLy8gYSBsaXN0ZW5lciBtaWdodCBoYXZlIHN0b3BwZWQgdXMgaW4gX29uVXBkYXRlXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQ29uZGl0aW9ucyBmb3Igc3RvcHBpbmcgdGhlIHNwcmluZyBhbmltYXRpb25cbiAgICBsZXQgaXNPdmVyc2hvb3RpbmcgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5fb3ZlcnNob290Q2xhbXBpbmcgJiYgdGhpcy5fc3RpZmZuZXNzICE9PSAwKSB7XG4gICAgICBpZiAodGhpcy5fc3RhcnRQb3NpdGlvbiA8IHRoaXMuX3RvVmFsdWUpIHtcbiAgICAgICAgaXNPdmVyc2hvb3RpbmcgPSBwb3NpdGlvbiA+IHRoaXMuX3RvVmFsdWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpc092ZXJzaG9vdGluZyA9IHBvc2l0aW9uIDwgdGhpcy5fdG9WYWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgaXNWZWxvY2l0eSA9IE1hdGguYWJzKHZlbG9jaXR5KSA8PSB0aGlzLl9yZXN0U3BlZWRUaHJlc2hvbGQ7XG4gICAgbGV0IGlzRGlzcGxhY2VtZW50ID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5fc3RpZmZuZXNzICE9PSAwKSB7XG4gICAgICBpc0Rpc3BsYWNlbWVudCA9XG4gICAgICAgIE1hdGguYWJzKHRoaXMuX3RvVmFsdWUgLSBwb3NpdGlvbikgPD0gdGhpcy5fcmVzdERpc3BsYWNlbWVudFRocmVzaG9sZDtcbiAgICB9XG5cbiAgICBpZiAoaXNPdmVyc2hvb3RpbmcgfHwgKGlzVmVsb2NpdHkgJiYgaXNEaXNwbGFjZW1lbnQpKSB7XG4gICAgICBpZiAodGhpcy5fc3RpZmZuZXNzICE9PSAwKSB7XG4gICAgICAgIC8vIEVuc3VyZSB0aGF0IHdlIGVuZCB1cCB3aXRoIGEgcm91bmQgdmFsdWVcbiAgICAgICAgdGhpcy5fbGFzdFBvc2l0aW9uID0gdGhpcy5fdG9WYWx1ZTtcbiAgICAgICAgdGhpcy5fbGFzdFZlbG9jaXR5ID0gMDtcbiAgICAgICAgdGhpcy5fb25VcGRhdGUodGhpcy5fdG9WYWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX19kZWJvdW5jZWRPbkVuZCh7ZmluaXNoZWQ6IHRydWV9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5fYW5pbWF0aW9uRnJhbWUgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5vblVwZGF0ZS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIHN0b3AoKTogdm9pZCB7XG4gICAgc3VwZXIuc3RvcCgpO1xuICAgIHRoaXMuX19hY3RpdmUgPSBmYWxzZTtcbiAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZW91dCk7XG4gICAgZ2xvYmFsLmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuX2FuaW1hdGlvbkZyYW1lKTtcbiAgICB0aGlzLl9fZGVib3VuY2VkT25FbmQoe2ZpbmlzaGVkOiBmYWxzZX0pO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU3ByaW5nQW5pbWF0aW9uO1xuIl19